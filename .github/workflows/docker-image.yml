name: Docker Image CI

on:
  push:
    branches:
      - 'main'
      - 'bugfix/*'
      - 'feature/*'

jobs:
  release:
    if: |
      github.ref == 'refs/heads/main' &&
      !startsWith(github.event.head_commit.message, 'doc') &&
      !contains(github.event.head_commit.message, 'WIP') &&
      !startsWith(github.event.head_commit.message, 'chore(release):') &&
      !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install semantic-release
        run: npm install -g semantic-release@25 @semantic-release/changelog@latest @semantic-release/git@latest @semantic-release/github@latest
      - name: Run semantic-release
        id: semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OUTPUT=$(semantic-release --dry-run 2>&1) || true
          echo "$OUTPUT"
          NEXT_VERSION=$(echo "$OUTPUT" | grep "The next release version is" | sed 's/.*The next release version is //' | awk '{print $1}' | head -1)
          if [ -n "$NEXT_VERSION" ] && [ "$NEXT_VERSION" != "" ]; then
            echo "new_release_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            echo "Next version: $NEXT_VERSION"
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
            echo "No release needed"
          fi
      - name: Set up Docker Buildx
        if: steps.semantic-release.outputs.new_release_published == 'true'
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        if: steps.semantic-release.outputs.new_release_published == 'true'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
      - name: Build and push Docker image
        if: steps.semantic-release.outputs.new_release_published == 'true'
        env:
          VERSION: ${{ steps.semantic-release.outputs.new_release_version }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          IMAGE_NAME=$(jq -r .name package.json | tr '[:upper:]' '[:lower:]' | tr -d '@' | tr '/' '-')
          TAG_LATEST="ghcr.io/$REPO_OWNER/$IMAGE_NAME:latest"
          TAG_VERSION="ghcr.io/$REPO_OWNER/$IMAGE_NAME:$VERSION"
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t "$TAG_LATEST" -t "$TAG_VERSION" \
            --push .
      - name: Publish release
        if: steps.semantic-release.outputs.new_release_published == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: semantic-release

  build-branch:
    if: |
      github.ref != 'refs/heads/main' &&
      !startsWith(github.event.head_commit.message, 'doc') &&
      !contains(github.event.head_commit.message, 'WIP') &&
      !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install semantic-release
        run: npm install -g semantic-release@25 @semantic-release/changelog@latest @semantic-release/git@latest @semantic-release/github@latest
      - name: Determine next version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OUTPUT=$(semantic-release --dry-run 2>&1) || true
          echo "$OUTPUT"
          NEXT_VERSION=$(echo "$OUTPUT" | grep "The next release version is" | sed 's/.*The next release version is //' | awk '{print $1}' | head -1)
          if [ -n "$NEXT_VERSION" ] && [ "$NEXT_VERSION" != "" ]; then
            echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
            echo "Would become version: $NEXT_VERSION if merged to main"
          else
            CURRENT_VERSION=$(jq -r .version package.json)
            echo "next_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "No version bump needed, using current: $CURRENT_VERSION"
          fi
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
      - name: Build and push Docker image
        env:
          NEXT_VERSION: ${{ steps.version.outputs.next_version }}
          BRANCH_NAME: ${{ github.ref_name }}
          REPO_OWNER: ${{ github.repository_owner }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          IMAGE_NAME=$(jq -r .name package.json | tr '[:upper:]' '[:lower:]' | tr -d '@' | tr '/' '-')
          BRANCH_SANITIZED=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          FULL_VERSION="${NEXT_VERSION}-${BRANCH_SANITIZED}-${RUN_NUMBER}"
          TAG_BRANCH="ghcr.io/$REPO_OWNER/$IMAGE_NAME:$FULL_VERSION"
          TAG_BRANCH_LATEST="ghcr.io/$REPO_OWNER/$IMAGE_NAME:${NEXT_VERSION}-${BRANCH_SANITIZED}-latest"
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t "$TAG_BRANCH" -t "$TAG_BRANCH_LATEST" \
            --push .
